%%--------------------------------------------------------%%
%%                    TVP-VAR package                     %%
%%--------------------------------------------------------%%
%%
%%  files = export_results_images(outdir)
%%
%%  Export TVP-VAR result Excel files to PNG images.
%%
%%  [input]
%%    outdir: output directory for images (optional)
%%            default: 'tvpvar_images'
%%
%%  [output]
%%    files: struct of generated image paths
%%
%%  This function looks for files generated by mcmc.m:
%%    - tvpvar_vol.xlsx
%%    - tvpvar_a.xlsx
%%    - tvpvar_ai.xlsx
%%    - tvpvar_int.xlsx
%%    - tvpvar_imp.xlsx
%%

function files = export_results_images(outdir)

if nargin < 1 || isempty(outdir)
    outdir = 'tvpvar_images';
end

if ~exist(outdir, 'dir')
    mkdir(outdir);
end

files = struct('vol', '', 'a', '', 'ai', '', 'int', '', 'imp', '');

files.vol = export_posterior_bands('tvpvar_vol.xlsx', outdir, 'volatility');
files.a   = export_posterior_bands('tvpvar_a.xlsx', outdir, 'a_t');
files.ai  = export_posterior_bands('tvpvar_ai.xlsx', outdir, 'a_inverse_t');
files.int = export_posterior_bands('tvpvar_int.xlsx', outdir, 'intercept_t');
files.imp = export_impulse_grid('tvpvar_imp.xlsx', outdir);

fprintf('\n[export_results_images] Done.\n');
end

function outpath = export_posterior_bands(xlsxFile, outdir, tag)
outpath = '';

if exist(xlsxFile, 'file') ~= 2
    fprintf('[skip] %s not found.\n', xlsxFile);
    return;
end

raw = readtable(xlsxFile);
arr = table2array(raw);

if isempty(arr) || size(arr,2) < 3
    fprintf('[skip] %s has unexpected format.\n', xlsxFile);
    return;
end

t = arr(:,1);
vals = arr(:,2:end);
ncol = size(vals,2);
if mod(ncol,2) ~= 0
    fprintf('[skip] %s does not contain mean/sd column pairs.\n', xlsxFile);
    return;
end

nvar = ncol / 2;
nr = ceil(sqrt(nvar));
nc = ceil(nvar / nr);

fig = figure('Visible','off', 'Color', 'w');
tiledlayout(nr, nc, 'TileSpacing', 'compact', 'Padding', 'compact');

for i = 1:nvar
    mu = vals(:, i);
    sd = vals(:, nvar + i);

    nexttile;
    plot(t, mu, 'b-', 'LineWidth', 1.3); hold on;
    plot(t, mu - sd, 'r:', 'LineWidth', 1.0);
    plot(t, mu + sd, 'r:', 'LineWidth', 1.0);
    yline(0, 'Color', [0.65 0.65 0.65]);
    hold off;
    title(sprintf('%s #%d', tag, i), 'Interpreter', 'none');
    xlabel('t');
    grid on;
end

outpath = fullfile(outdir, sprintf('%s.png', tag));
exportgraphics(fig, outpath, 'Resolution', 180);
close(fig);
fprintf('[ok] %s -> %s\n', xlsxFile, outpath);
end

function outpath = export_impulse_grid(xlsxFile, outdir)
outpath = '';

if exist(xlsxFile, 'file') ~= 2
    fprintf('[skip] %s not found.\n', xlsxFile);
    return;
end

raw = readtable(xlsxFile);
arr = table2array(raw);

if isempty(arr) || size(arr,2) < 4
    fprintf('[skip] %s has unexpected format.\n', xlsxFile);
    return;
end

% Expected numeric columns after headers written by mcmc.m:
% col1: t, col2: horizon, col3..: responses stacked by (shock,response)

t = arr(:,1);
h = arr(:,2);
imp = arr(:,3:end);

vT = unique(t(~isnan(t)));
vH = unique(h(~isnan(h)));
vH = sort(vH(:)');

if isempty(vH)
    fprintf('[skip] %s does not contain valid horizon column.\n', xlsxFile);
    return;
end

nrow = size(imp, 1);
nh = length(vH);
if mod(nrow, nh) ~= 0
    fprintf('[skip] %s has inconsistent impulse row size for reshape.\n', xlsxFile);
    return;
end
ns = nrow / nh;

npair = size(imp,2);
nk = round(sqrt(npair));
if nk^2 ~= npair
    fprintf('[skip] %s impulse columns are not square (nk^2).\n', xlsxFile);
    return;
end

% Determine representative time index robustly:
% t is only filled at the first row of each time block in mcmc output.
tBlock = t(1:nh:end);
validBlock = find(~isnan(tBlock));
if isempty(validBlock)
    midx = round(ns/2);
    tLabel = midx;
else
    midPos = round(length(validBlock)/2);
    midx = validBlock(midPos);
    tLabel = tBlock(midx);
end
if isempty(validBlock) && ~isempty(vT)
    tLabel = vT(max(1, min(round(length(vT)/2), length(vT))));
end

% Reshape: each column is stacked [horizon x t]
fig = figure('Visible','off', 'Color', 'w');
tiledlayout(nk, nk, 'TileSpacing', 'compact', 'Padding', 'compact');

for col = 1:npair
    mat = reshape(imp(:,col), nh, [])';
    curve = mat(midx,:);

    nexttile;
    plot(vH, curve, 'k-', 'LineWidth', 1.2);
    yline(0, 'Color', [0.65 0.65 0.65]);
    title(sprintf('shock %d -> resp %d', ceil(col/nk), mod(col-1,nk)+1));
    xlabel('horizon');
    grid on;
end

sgtitle(sprintf('Impulse responses at t=%g', tLabel));
outpath = fullfile(outdir, 'impulse_midtime.png');
exportgraphics(fig, outpath, 'Resolution', 180);
close(fig);

fprintf('[ok] %s -> %s\n', xlsxFile, outpath);
end
